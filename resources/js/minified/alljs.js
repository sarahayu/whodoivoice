function resolveCollisionVelocity(a,b){let c=p5.Vector.sub(b.location,a.location),d=c.magSq(),e=a.radius+b.radius;if(d>e*e)return;let f=Math.sqrt(d);0==f?(penetration=a.radius,c=createVector(1,0)):(penetration=e-f,c.normalize());let g=p5.Vector.sub(b.velocity,a.velocity),h=g.dot(c);if(0<h)return;let i=-(1+RESTITUTION)*h;i/=a.invMass+b.invMass;let k=p5.Vector.mult(c,i);a.velocity.sub(p5.Vector.div(k,a.mass)),b.velocity.add(p5.Vector.div(k,b.mass))}function correctPositions(a,b){let c=p5.Vector.sub(b.location,a.location),d=c.magSq(),e=a.radius+b.radius;if(d>e*e)return;let f=Math.sqrt(d);0==f?(penetration=a.radius,c=createVector(1,0)):(penetration=e-f,c.normalize());let g=p5.Vector.mult(c,.9*Math.max(penetration-.08,0));a.location.sub(p5.Vector.mult(g,.5)),b.location.add(p5.Vector.mult(g,.5))}function BubbleAnimation(a){this.radius=a,this.apparentRadius=a,this.stroke=10*(this.apparentRadius/100),this.constRadius=a,this.expanding=!1}BubbleAnimation.prototype.update=function(a){this.radius=min(max(this.radius+50*((this.expanding?1:-1)*a),this.constRadius),this.constRadius+10),this.apparentRadius=this.radius+5*(this.radius-this.constRadius),this.stroke=lerp(MAX_STROKE*(this.apparentRadius/(MAX_RADIUS+RADIUS_EXPAND)),HOVER_STROKE,this.percentOfFullSize())},BubbleAnimation.prototype.percentOfFullSize=function(){return(this.radius-this.constRadius)/RADIUS_EXPAND};function Bubble(a,b,c,d,e){this.radius=a,this.constRadius=a,this.mass=1e3*a,this.invMass=1/this.mass,this.location=createVector(b,c),this.velocity=createVector(0,0),this.animation=new BubbleAnimation(a),this.dragged=!1;let f=min(d.width,d.height);this.image=d.get(0,0,f,f),this.image.resize(MAX_RADIUS+RADIUS_EXPAND,MAX_RADIUS+RADIUS_EXPAND),this.image.mask(circleMask),this.relativeScale=e}Bubble.prototype.update=function(){let a=p5.Vector.sub(this.location,createVector(mouseX,mouseY)).magSq()<=this.radius*this.radius;a&&cursor(HAND),this.animation.expanding=(!bubbleGrabbed||this.dragged)&&a,this.animation.update(FRAME_LEN),this.radius=this.animation.radius,!bubbleGrabbed&&a&&mouseIsPressed?this.dragged=bubbleGrabbed=!0:!bubbleGrabbed&&(this.dragged=!1),this.dragged?this.location=createVector(mouseX,mouseY):(this.velocity.add(getGravVector(this.location)),onScreen(this.location,0)&&this.velocity.mult(velocityFactor),this.location.add(p5.Vector.mult(this.velocity,FRAME_LEN)))},Bubble.prototype.draw=function(a,b){b?(a.noStroke(),a.fill("white"),a.ellipse(this.location.x,this.location.y,2*this.animation.apparentRadius),a.image(this.image,this.location.x,this.location.y,2*this.animation.apparentRadius-2*this.animation.stroke,2*this.animation.apparentRadius-2*this.animation.stroke)):(a.push(),a.noStroke(),a.fill("white"),a.drawingContext.shadowOffsetX=2,a.drawingContext.shadowOffsetY=2,a.drawingContext.shadowBlur=8,a.drawingContext.shadowColor="rgba(0,0,0,0.5)",a.ellipse(this.location.x,this.location.y,2*this.animation.apparentRadius),a.pop(),a.push(),a.noStroke(),a.noFill(),a.fill("#FEEAE0"),a.ellipse(this.location.x,this.location.y,2*this.animation.apparentRadius-2*this.animation.stroke),a.image(this.image,this.location.x,this.location.y,2*this.animation.apparentRadius-2*this.animation.stroke,2*this.animation.apparentRadius-2*this.animation.stroke),a.pop())},Bubble.prototype.drawLabel=function(a){drawCurvedText("Momotarou Kabakura",this.animation.apparentRadius-this.animation.stroke+this.animation.stroke*lerp(.2,.3,1-this.relativeScale),lerp(.7,.8,this.relativeScale)*this.animation.stroke,this.location.x,this.location.y,this.animation.expanding?this.animation.percentOfFullSize()-1:1-this.animation.percentOfFullSize(),`rgba(0,0,0,${this.animation.percentOfFullSize()})`,a)};function getGravVector(a){let b;if(windowWidth>windowHeight){const c=windowHeight/2;let d=createVector(c,c),e=createVector(windowWidth-c,c);b=a.x>=d.x&&a.x<=e.x?createVector(0,c-a.y):p5.Vector.sub(a.x>e.x?e:d,a)}else{const c=windowHeight/2;let d=createVector(c,c),e=createVector(windowHeight-c,c);b=a.y<=d.y&&a.y>=e.y?createVector(0,c-a.x):p5.Vector.sub(a.y>e.y?e:d,a)}return b.normalize(),b.mult(1e3*FRAME_LEN),b}function update(){velocityFactor=max(velocityFactor*=velocityDecreaseRate,.5),bubbleQueue.length==bubbles.length?frame==INTRO_BUBBLE_EVERY_N_FRAME*bubbleQueue.length-INTRO_BUBBLE_EVERY_N_FRAME+1&&(console.log("Slowing down now"),frame++,setTimeout(()=>{velocityDecreaseRate=.998},2e3)):(0==frame%INTRO_BUBBLE_EVERY_N_FRAME&&bubbles.push(bubbleQueue[bubbles.length]),frame++),cursor(ARROW);for(const a of bubbles)a.update();for(let a=0;a<bubbles.length-1;a++)for(let b=a+1;b<bubbles.length;b++)resolveCollisionVelocity(bubbles[a],bubbles[b]);for(let a=0;a<bubbles.length-1;a++)for(let b=a+1;b<bubbles.length;b++)correctPositions(bubbles[a],bubbles[b])}function render(){background("#DADADA"),buffer.clear();let a,b=[];for(const c of bubbles)c.animation.expanding?a=c:c.animation.radius==c.animation.constRadius?c.draw(buffer,!0):b.push(c);push(),image(buffer,0,0),pop(),push(),textAlign(CENTER,BASELINE),imageMode(CENTER);for(const a of b)a.draw(this,!1),a.drawLabel(this);a&&(a.draw(this,!1),a.drawLabel(this)),pop()}const FPS=60,FRAME_LEN=1/60,INTRO_BUBBLE_EVERY_N_FRAME=4,RESTITUTION=.1,MAX_RADIUS=100,RADIUS_EXPAND=10,MAX_STROKE=10,HOVER_STROKE=30,MAX_BUBBLES=55;let gravity,velocityFactor,bubbleCanvas,font,circleMask,buffer,velocityDecreaseRate=.99995,frame=0,bubbleQueue=[],bubbles=[],bubbleGrabbed=!1;function preload(){circleMask=createGraphics(200,200),circleMask.circle(100,100,200);for(let a=0;a<MAX_BUBBLES;a++)(function(a){loadImage(`https://picsum.photos/${Math.floor(300*Math.random())+100}`,b=>{let c=getOffscreenPoint(),d=Math.pow((MAX_BUBBLES-a)/MAX_BUBBLES,2);bubbleQueue.push(new Bubble(60*d+40,c.x,c.y,b,d))})})(a)}function setup(){gravity=windowHeight,velocityFactor=1,bubbleCanvas=createCanvas(windowWidth,windowHeight),bubbleCanvas.parent("bubble-area"),frameRate(FPS),buffer=createGraphics(windowWidth,windowHeight),buffer.textAlign(CENTER,BASELINE),buffer.imageMode(CENTER)}function draw(){update(),render()}function windowResized(){resizeCanvas(windowWidth,windowHeight),buffer=createGraphics(windowWidth,windowHeight),buffer.textAlign(CENTER,BASELINE),buffer.imageMode(CENTER),gravity=windowHeight}function mouseReleased(){bubbleGrabbed=!1}function getOffscreenPoint(){let a;do a=createVector(Math.random()*(windowWidth+1e3)-500,Math.random()*(windowHeight+1e3)-500);while(onScreen(a,100));return a}function onScreen(a,b){return a.x>=-b&&a.x<=windowWidth+b&&a.y>=-b&&a.y<=windowHeight+b}function drawCurvedText(a,b,c,d,e,f,g,h){h.textFont("Courier New",c);let j=0,k=h.textWidth(a)/b;for(let l=0;l<a.length;l++){let c=a.charAt(l),i=h.textWidth(c);j+=i/2;let m=j/b-k/2+f;h.push(),h.fill(g),h.translate(d,e),h.rotate(m),h.translate(0,-b),h.text(c,0,0),h.pop(),j+=i/2}}